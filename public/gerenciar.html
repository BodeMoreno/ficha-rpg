<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerenciar fichas</title>
  <style>
    body{font-family:system-ui,Arial; background:#111; color:#fff; margin:0; padding:24px}
    .card{max-width:820px; margin:0 auto; background:#1a1a1a; border:1px solid #333; border-radius:12px; padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,button{padding:10px 12px; font-size:14px}
    select{min-width:min(92vw,520px)}
    button{cursor:pointer; border:0; border-radius:10px}
    .danger{background:#b00020; color:#fff}
    .primary{background:#2b66ff; color:#fff}
    .ghost{background:#2a2a2a; color:#fff}
    .muted{opacity:.85; font-size:13px; margin-top:10px; white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 12px">Gerenciar fichas</h2>

    <div class="row">
      <select id="sel"></select>
      <button class="primary" id="abrir">Abrir</button>
      <button class="danger" id="excluir">Excluir</button>
      <button class="ghost" id="recarregar">Recarregar</button>
      <button class="ghost" id="nova">Nova ficha</button>
      <button class="ghost" id="home">Menu</button>
    </div>

    <div class="muted" id="info"></div>
    <div class="muted">Dica: preencha Nome/Classe/Raça para a lista ficar legível.</div>
  </div>

<script>
  const sel = document.getElementById("sel");
  const info = document.getElementById("info");

  function labelOf(f){
    const parts = [];
    if (f.nome) parts.push(f.nome);
    const meta = [f.classe, f.raca].filter(Boolean).join(" / ");
    if (meta) parts.push(" (" + meta + ")");
    if (f.titulo) parts.push(" — " + f.titulo);
    const main = parts.join("").trim();
    return main ? main : "(sem nome) — " + f.id;
  }

  async function carregarLista(){
    sel.innerHTML = "";
    info.textContent = "Carregando...";
    const res = await fetch("/fichas");
    const lista = await res.json();

    if (!Array.isArray(lista) || lista.length === 0){
      info.textContent = "Nenhuma ficha salva ainda.";
      return;
    }

    lista.sort((a,b) => (a.nome || "zzzz").localeCompare(b.nome || "zzzz"));

    for (const f of lista){
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = labelOf(f);
      sel.appendChild(opt);
    }

    info.textContent = "Total: " + lista.length + " ficha(s).";
  }

  document.getElementById("abrir").onclick = () => {
    const id = sel.value;
    if (!id) return;
    location.href = "/ficha.html?id=" + encodeURIComponent(id);
  };

  document.getElementById("excluir").onclick = async () => {
    const id = sel.value;
    if (!id) return;

    const texto = sel.options[sel.selectedIndex]?.textContent || id;
    const ok = confirm("Excluir esta ficha?\n\n" + texto + "\n\nIsso não tem desfazer.");
    if (!ok) return;

    const res = await fetch("/ficha/" + encodeURIComponent(id), { method: "DELETE" });
    if (!res.ok){
      const err = await res.json().catch(() => ({}));
      alert("Falhou: " + (err.error || ("HTTP " + res.status)));
      return;
    }

    await carregarLista();
  };

  document.getElementById("recarregar").onclick = carregarLista;
  document.getElementById("nova").onclick = () => location.href = "/nova.html";
  document.getElementById("home").onclick = () => location.href = "/";

  carregarLista();
</script>
</body>
</html>
